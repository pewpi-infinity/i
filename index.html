<script>

// ----------------------------
//  GITHUB WRITER
// ----------------------------
async function writeToRepo(text) {
    try {
        await fetch("https://api.github.com/repos/pewpi-infinity/i/dispatches", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/vnd.github+json"
            },
            body: JSON.stringify({
                event_type: "octave_write",
                client_payload: { text: text }
            })
        });
    } catch (err) {
        console.log("GitHub write error:", err);
    }
}

// ----------------------------
//  TERMINAL + OCTAVE ENGINE
// ----------------------------
const terminal = document.getElementById("terminal");
const input = document.getElementById("commandInput");

// Frequency encoder (matching Python)
function octaveEncode(text) {
    if (!text || text.length < 1) return [0,0];
    const note = text.charCodeAt(0) % 7;
    const octave = (text.charCodeAt(0) % 3) + 3;
    const freq = 220 * Math.pow(2, (note / 12));
    return [freq, octave];
}

// Semantic mock (JS version)
function octaveSemantic(topic) {
    topic = topic.toLowerCase();

    const data = `
        this is placeholder semantic data
        once DATA_CHAMBER is synced here
        semantic scan will match real terms
    `.toLowerCase();

    const hits = data.split("\n").filter(l => l.includes(topic));
    return hits.length > 0 ? hits.slice(0, 5).join("\n") : "No semantic links found.";
}

// Command dispatch
function octaveDispatch(pkt, raw) {
    if (raw.includes("find") || raw.includes("scan")) {
        const t = raw.replace("find", "").replace("scan", "").trim();
        return "Semantic links for '" + t + "':\n" + octaveSemantic(t);
    }
    return "Octave OS: Command acknowledged.";
}

// ----------------------------
//  ENTER KEY HANDLER — FIXED
// ----------------------------
input.addEventListener("keydown", async function(e) {
    if (e.key !== "Enter") return;

    const cmd = input.value.trim();
    if (cmd.length === 0) return;

    // Echo in terminal
    terminal.innerHTML += "\n∞ > " + cmd;

    // Send to GitHub repo memory
    writeToRepo(cmd);

    // Generate response
    const packet = octaveEncode(cmd);
    const out = octaveDispatch(packet, cmd);

    terminal.innerHTML += "\n" + out + "\n";

    // Scroll properly
    terminal.scrollTop = terminal.scrollHeight;

    // Clear input
    input.value = "";
});
</script>
